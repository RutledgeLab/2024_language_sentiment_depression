---
title: "Project NLP Depression (Manuscript Results Analyses)"
author: "Jihyun Hur"
date: "2024-05-11"
output: html_document
---

```{r setup, include=FALSE}
library(dplyr)
library(stringr)
library(ggcorrplot)
library(ggpubr)
library(ggeffects)
library(jtools)
library(broom)
library(purrr)
library(car)
library(robustbase)
library(knitr)
library(kableExtra)
library(broom)
library(sjPlot)
library(psych)
library(gtsummary)
library(robustlmm)
library(tidyr)
library(lmerTest)
library(rcartocolor)  
library(rstatix)     
library(R.matlab)
library(ggtext)

# set working directory
cur_dir <- '/Users/jihyunhur/Yale/2_Github/project_language_sentiment_depression/2_scripts'
dat_dir <- '/Users/jihyunhur/Yale/2_Github/project_language_sentiment_depression/1_data'
dir_save <- '/Users/jihyunhur/Yale/2_Github/project_language_sentiment_depression/2_scripts/figures'

dat <- read.csv(file.path(dat_dir,'data.csv'))

study1_data <- dat %>% filter(study_num == 1)
study2_data <- dat %>% filter(study_num == 2)
```

## Results

1. Positive and negative human sentiment Spearman correlation
```{r ms 1}
## Study 1
cor.test(study1_data$avg_human_tone_pos_mean, study1_data$avg_human_tone_neg_mean, method="spearman")

## Study 2
cor.test(study2_data$avg_human_tone_pos_mean, study2_data$avg_human_tone_neg_mean, method="spearman")
```

2. Human sentiment score ~ PHQ-9 at baseline
```{r ms 2, echo=TRUE}
## Study 1
cor.test(study1_data$phq, study1_data$avg_human_tone_mean_diff, method="spearman")

## Study 2
cor.test(study2_data$phq, study2_data$avg_human_tone_mean_diff, method="spearman")
```

3. Human sentiment score ~ PHQ-9 at follow-up
```{r ms 3, echo=TRUE}
## Study 1
cor.test(study1_data$phq_2, study1_data$avg_human_tone_mean_diff, method="spearman")

## Study 2
cor.test(study2_data$phq_2, study2_data$avg_human_tone_mean_diff, method="spearman")
```


4. PHQ-9 at baseline ~ PHQ-9 at follow-up
```{r ms 4, echo=TRUE}
## Study 1
cor.test(study1_data$phq, study1_data$phq_2, method="spearman")

## Study 2
cor.test(study2_data$phq, study2_data$phq_2, method="spearman")
```

5-1. Robust regression testing prediction using human sentiment score 
```{r ms 5, echo=TRUE}
pi <- c(`(Intercept)` = "Intercept",
        phq = "Initial PHQ-9 score",
        avg_human_tone_mean_diff = "Human sentiment score", 
        avg_human_tone_pos_mean = "Human positivity score",  
        avg_human_tone_neg_mean = "Human negativity score",
        gpt_tone_mean_diff = "ChatGPT sentiment score", 
        gpt_tone_pos_mean = "ChatGPT positivity score",
        gpt_tone_neg_mean = "ChatGPT negativity score",
        liwc_tone_mean_diff = "LIWC sentiment score", 
        liwc_tone_pos_mean = "LIWC positivity score", 
        liwc_tone_neg_mean = "LIWC negativity score",
        base_hap = "Baseline mood")

terms_use <- c("phq", "avg_human_tone_mean_diff", "avg_human_tone_pos_mean", "avg_human_tone_neg_mean", 
               "gpt_tone_mean_diff", "gpt_tone_pos_mean", "gpt_tone_neg_mean",
               "liwc_tone_mean_diff", "liwc_tone_pos_mean", "liwc_tone_neg_mean")

## Study 1
ms5_study1_mod <- lmrob(phq_2   ~  phq + age + gender + edu +  avg_human_tone_mean_diff, data=study1_data,  control = lmrob.control(setting = "KS2014", k.max=2000))

tab_model(ms5_study1_mod,  terms = terms_use, 
          show.ci = FALSE, show.se = TRUE,
             pred.labels = pi, dv.labels = c(""), string.pred = "Coeffcient",
            show.stat = "TRUE", string.est = "Beta estimates", string.stat = "T-stat",
            string.se = "SE", string.p = "P")

# f^2 calculation
# model without sentiment score
ms5_study1_mod2<-lmrob(phq_2   ~  phq  + age + gender + edu, data=study1_data,  control = lmrob.control(setting = "KS2014", k.max=2000))
s1_mod_f <- (summary(ms5_study1_mod)$r.squared - summary(ms5_study1_mod2)$r.squared)/(1-summary(ms5_study1_mod)$r.squared)
sprintf('Study 1 regression model Cohen f^2 = %.3f', s1_mod_f)

# Wald test
anova(ms5_study1_mod, ms5_study1_mod2, test='Wald')

## Study 2
ms5_study2_mod <- lmrob(phq_2   ~  phq + age + gender + edu +  avg_human_tone_mean_diff, data=study2_data,  control = lmrob.control(setting = "KS2014", k.max=2000))

tab_model(ms5_study2_mod,  terms = terms_use, 
          show.ci = FALSE, show.se = TRUE,
             pred.labels = pi, dv.labels = c(""), string.pred = "Coeffcient",
            show.stat = "TRUE", string.est = "Beta estimates", string.stat = "T-stat",
            string.se = "SE", string.p = "P")

# f^2 calculation
# model without sentiment score
ms5_study2_mod2<-lmrob(phq_2   ~  phq  + age + gender + edu, data=study2_data,  control = lmrob.control(setting = "KS2014", k.max=2000))
s2_mod_f <- (summary(ms5_study2_mod)$r.squared - summary(ms5_study2_mod2)$r.squared)/(1-summary(ms5_study2_mod)$r.squared)
sprintf('Study 2 regression model Cohen f^2 = %.3f', s2_mod_f)

# Wald test
anova(ms5_study2_mod, ms5_study2_mod2, test='Wald')
```

5-2. Robust regression results human sentiment plots (Fig. 1A)
```{r ms 5-2}
reg_mod <- plot_summs(ms5_study1_mod, ms5_study2_mod, scale=FALSE, inner_ci_level = .95,  plot.distributions = FALSE,
                 rescale.distributions = TRUE,   # = c("age", "gender"),
                 coefs = c(
                   "Initial \nPHQ-9 score" = 'phq',
                   "Human \nsentiment score" = "avg_human_tone_mean_diff"),
                 model.names=c('Study 1', 'Study 2')) + scale_x_continuous(limits = c(-0.51, 1.01), 
                                                                           breaks=c(-0.50, 0.00, 0.50, 1.00))
fig_1a <- ggpar(reg_mod, xlab = 'Beta Coefficient',
            font.y = 0,
            ggtheme = theme_pubr()) + theme(legend.title = element_blank(), legend.position = c(0.3,0.95),
                                            legend.direction = "horizontal")
fig_1a
```

6-1. LOOCV prediction (Study 1)
```{r ms 6-1, echo=FALSE}
# Study 1 LOOCV prediction
loocv.fitted.values1 <- NULL
loocv.fitted.values2 <- NULL

study1_data_loocv <- study1_data

for (i in 1:nrow(study1_data_loocv)) {
  loo.data <- study1_data_loocv[-i,]

  # sentiment model
  model1<-lmrob(phq_diff  ~ phq + avg_human_tone_mean_diff + age + gender + edu, data=study1_data_loocv,  control = lmrob.control(setting = "KS2014", k.max=2000))
  loocv.fitted.values1[i]  <- predict(model1, newdata=study1_data_loocv[i,], type = "response")

  # without sentiment model
  model2<-lmrob(phq_diff  ~  phq + age + gender + edu, data=study1_data_loocv,  control = lmrob.control(setting = "KS2014", k.max=2000))
  loocv.fitted.values2[i] <- predict(model2, newdata=study1_data_loocv[i,], type = "response")
}

study1_data_loocv$loocv.pred1         <- loocv.fitted.values1
study1_data_loocv$loocv.pred2         <- loocv.fitted.values2

study1_data_plot <- study1_data_loocv %>% filter(!is.nan(age))
```

6-2. LOOCV prediction (Study 2)
```{r ms 6-2, echo=FALSE}
# Study 2 LOOCV prediction
loocv.fitted.values1 <- NULL
loocv.fitted.values2 <- NULL

# If only one participant in the category, the model doesn't converge
study2_data_loocv <- study2_data %>% filter(!is.nan(age) & edu != "Prefer not to say")

for (i in 1:nrow(study2_data_loocv)) {
  loo.data <- study2_data_loocv[-i,]
  # sentiment model
  model1<-lmrob(phq_diff   ~ phq + avg_human_tone_mean_diff + age + gender + edu, data=study2_data_loocv,  control = lmrob.control(setting = "KS2014", k.max=2000))
  loocv.fitted.values1[i] <- predict(model1, newdata=study2_data_loocv[i,], type = "response")

  # without sentiment model
  model2<-lmrob(phq_diff   ~   phq + age + gender + edu, data=study2_data_loocv,  control = lmrob.control(setting = "KS2014", k.max=2000))
  loocv.fitted.values2[i] <- predict(model2, newdata=study2_data_loocv[i,], type = "response")
}

study2_data_loocv$loocv.pred1         <- loocv.fitted.values1
study2_data_loocv$loocv.pred2         <- loocv.fitted.values2

study2_data_plot <- study2_data_loocv
```

6-3. LOOCV results and plot (Fig. 1B)
```{r ms 6-3, echo=FALSE}
# Study 1
s1_mse <- mean((study1_data_plot$phq_diff-study1_data_plot$loocv.pred1)^2, na.rm=TRUE)
sprintf("Study 1 LOOCV MSE = %.2f", s1_mse)

s1_R <- cor.test(study1_data_plot$phq_diff, study1_data_plot$loocv.pred1, method="pearson")
sprintf("Study 1 Pred ~ Actual R = %.2f (P = %.3f)", s1_R$estimate[[1]], s1_R$p.value)

# Study 1
s2_mse <- mean((study2_data_plot$phq_diff-study2_data_plot$loocv.pred1)^2, na.rm=TRUE)
sprintf("Study 2 LOOCV MSE = %.2f", s2_mse)

s2_R <- cor.test(study2_data_plot$phq_diff, study2_data_plot$loocv.pred1, method="pearson")
sprintf("Study 2 Pred ~ Actual R = %.2f (P = %.3f)", s2_R$estimate[[1]], s2_R$p.value)

study1_data_plot$study_num <- 1
study2_data_plot$study_num <- 2

merged_loocv_dat <- full_join(study1_data_plot, study2_data_plot)

t_tests = merged_loocv_dat %>%
  filter(!is.nan(phq_2)) %>%
  group_by(study_num,
           Group = cut(loocv.pred1, breaks = c(-Inf, -0.50, 0.50, +Inf),
           labels = c("Predicted \n PHQ-9 decrease", "Predicted \nPHQ-9 no change", "Predicted \nPHQ-9 increase"))) %>%
            summarise(P = wilcox.test(phq_diff, mu = 0)$p.value,
                    Sig = case_when(P < 0.005 ~ "***",
                                    P >= 0.05 ~ "ns",
                                    0.01 <= P & P < 0.05 ~ "*",
                                    0.005 <= P & P < 0.01 ~ "**"))

fig_1b <- merged_loocv_dat %>%
  filter(!is.nan(phq_2)) %>%
  group_by(study_num,
           Group = cut(loocv.pred1, breaks = c(-Inf, -0.50, 0.50, +Inf),
           labels = c("Predicted \nPHQ-9 decrease", "Predicted \nPHQ-9 no change", "Predicted \nPHQ-9 increase"))) %>%
  summarise(mean_fit_value = mean(loocv.pred1), sem_fit_value = sd(loocv.pred1) / sqrt(n()),
            mean_real_value = mean(phq_diff), sem_real_value = sd(phq_diff) / sqrt(n()),
            mean_null_value = mean(loocv.pred2), sem_null_value = sd(loocv.pred2) / sqrt(n())) %>%
  ggplot(aes(y = Group, x = mean_real_value)) +
  geom_vline(xintercept=0, alpha=0.5, linetype="dotted") +
  geom_pointrange(aes(y = Group, xmin = mean_real_value - sem_real_value, xmax = mean_real_value + sem_real_value,
  color = factor(study_num), shape = factor(study_num)), position = ggplot2::position_dodge(width = -0.6)) +
                    scale_shape_manual(values=c(1, 0), labels = c("Study 1", "Study 2")) +
                    scale_color_manual(values=c("#49b7fc", "#ff7b00"), labels = c("Study 1", "Study 2"))+
  labs(x = "Actual PHQ-9 Change", y="") + theme_pubr() + theme(legend.position = c(0.3,0.95), legend.direction = "horizontal", legend.title=element_blank())

fig_1b

# Fig 1
fig_1 <- ggarrange(fig_1a, fig_1b, ncol = 2, labels = c("A", "B"))
ggsave(filename = file.path(dir_save, "fig_1.pdf"), plot=fig_1, width=7, height=3.5, units="in", dpi=700)

```

6-4. Robust Mixed Linear Effect
```{r ms 6-4, include=TRUE, warning=FALSE}
# MIXED EFFECT
low_phq_lmer <- rlmer(phq_2   ~  phq + age + gender + edu + avg_human_tone_mean_diff + (1 |study_num), data = dat %>% filter(phq<=5))
summary(low_phq_lmer)

tab_model(low_phq_lmer, show.se = "TRUE", show.stat = "TRUE", string.est = "Beta estimates", string.stat = "T-stat", string.se = "SE", string.p = "P")

high_phq_lmer <- rlmer(phq_2   ~  phq + age + gender + edu +  avg_human_tone_mean_diff + (1 |study_num), data = dat %>% filter(phq>5))
summary(high_phq_lmer)

tab_model(high_phq_lmer, show.se = "TRUE", show.stat = "TRUE", string.est = "Beta estimates", string.stat = "T-stat", string.se = "SE", string.p = "P")

lmer_plot <- plot_summs(low_phq_lmer, high_phq_lmer, scale=FALSE, inner_ci_level = .95,  plot.distributions = FALSE,
                 rescale.distributions = FALSE,
                 coefs = c(
                   "Initial \nPHQ-9 score" = 'phq',
                   "Human sentiment score" = "avg_human_tone_mean_diff"),
                 model.names=c('Minimal PHQ-9 (PHQ-9<5)', 'Mild-to-moderate PHQ-9 (PHQ-9>=5)')) + scale_x_continuous(limits = c(-0.55, 1.01), breaks=c(-0.50, 0.00, 0.50, 1.00))

lmer_plot <- ggpar(lmer_plot, xlab = 'Beta Coefficient',
            font.y = 0, ggtheme = theme_pubr()) + theme(legend.title = element_blank(), legend.position = c(0.3,0.95), legend.direction = "horizontal")

lmer_plot

ggsave(filename = file.path(dir_save, "fig_s6.pdf"), plot=lmer_plot, width=6.5, height=3.5, units="in", dpi=600)
```

7. Linguistic distance ~ PHQ
```{r ms 7}
## Study 1
cor.test(study1_data$liwc_ling_dist, study1_data$phq, method="spearman")

# Study 2
cor.test(study2_data$liwc_ling_dist, study2_data$phq, method="spearman")
```

8. Correlation between human and ChatGPT (GPT-3.5) sentiment
```{r ms 8}
## Study 1
cor.test(study1_data$avg_human_tone_mean_diff, study1_data$gpt_tone_mean_diff, method="spearman")

## Study 2
cor.test(study2_data$avg_human_tone_mean_diff, study2_data$gpt_tone_mean_diff, method="spearman")
```

9. Correlation between PHQ-9 and ChatGPT (GPT-3.5) sentiment
```{r ms 9}
## Study 1
cor.test(study1_data$phq, study1_data$gpt_tone_mean_diff, method="spearman")

## Study 2
cor.test(study2_data$phq, study2_data$gpt_tone_mean_diff, method="spearman")
```

10-1. Robust regression testing prediction using ChatGPT sentiment score 
```{r ms 10-1, echo=FALSE}

## Study 1
ms10_study1_mod <- lmrob(phq_2   ~  phq + age + gender + edu +  gpt_tone_mean_diff, data=study1_data,  control = lmrob.control(setting = "KS2014", k.max=2000))

tab_model(ms10_study1_mod,  terms = terms_use, 
          show.ci = FALSE, show.se = TRUE,
             pred.labels = pi, dv.labels = c(""), string.pred = "Coeffcient",
            show.stat = "TRUE", string.est = "Beta estimates", string.stat = "T-stat",
            string.se = "SE", string.p = "P")

# f^2 calculation
# model without sentiment score
ms10_study1_mod2<-lmrob(phq_2   ~  phq  + age + gender + edu, data=study1_data,  control = lmrob.control(setting = "KS2014", k.max=2000))
s1_mod_f <- (summary(ms10_study1_mod)$r.squared - summary(ms10_study1_mod2)$r.squared)/(1-summary(ms10_study1_mod)$r.squared)
sprintf('Study 1 regression model Cohen f^2 = %.3f', s1_mod_f)

## Study 2
ms10_study2_mod <- lmrob(phq_2   ~  phq + age + gender + edu +  gpt_tone_mean_diff, data=study2_data,  control = lmrob.control(setting = "KS2014", k.max=2000))

tab_model(ms10_study2_mod,  terms = terms_use, 
          show.ci = FALSE, show.se = TRUE,
             pred.labels = pi, dv.labels = c(""), string.pred = "Coeffcient",
            show.stat = "TRUE", string.est = "Beta estimates", string.stat = "T-stat",
            string.se = "SE", string.p = "P")

# f^2 calculation
# model without sentiment score
ms10_study2_mod2<-lmrob(phq_2   ~  phq  + age + gender + edu, data=study2_data,  control = lmrob.control(setting = "KS2014", k.max=2000))
s2_mod_f <- (summary(ms10_study2_mod)$r.squared - summary(ms10_study2_mod2)$r.squared)/(1-summary(ms10_study2_mod)$r.squared)
sprintf('Study 2 regression model Cohen f^2 = %.3f', s2_mod_f)

```

10-2. Robust regression ChatGPT sentiment score plot (Fig. 2A)
```{r ms 10-2}
gpt_reg_mod <- plot_summs(ms10_study1_mod, ms10_study2_mod, scale=FALSE, inner_ci_level = .95,  plot.distributions = FALSE,
                 rescale.distributions = TRUE,   
                 coefs = c(
                   "Initial \nPHQ-9 score" = 'phq',
                   "ChatGPT \nsentiment score" = "gpt_tone_mean_diff"),
                 model.names=c('Study 1', 'Study 2')) + scale_x_continuous(limits = c(-0.51, 1.01), 
                                                                           breaks=c(-0.50, 0.00, 0.50, 1.00))
fig_2a <- ggpar(gpt_reg_mod, xlab = 'Beta Coefficient',
            font.y = 0,
            ggtheme = theme_pubr()) + theme(legend.title = element_blank(), legend.position = c(0.3,0.95),
                                            legend.direction = "horizontal")
fig_2a
```

11. LIWC ~ Human sentiment score
```{r ms 11}
## Study 1
cor.test(study1_data$liwc_tone_mean_diff, study1_data$avg_human_tone_mean_diff, method="spearman")

## Study 2
cor.test(study2_data$liwc_tone_mean_diff, study2_data$avg_human_tone_mean_diff, method="spearman")
```

12. LIWC ~ GPT sentiment score
```{r ms 12}
## Study 1
cor.test(study1_data$liwc_tone_mean_diff, study1_data$gpt_tone_mean_diff, method="spearman")

## Study 2
cor.test(study2_data$liwc_tone_mean_diff, study2_data$gpt_tone_mean_diff, method="spearman")
```

13. LIWC ~ PHQ-9 at baseline
```{r ms 13}
## Study 1
cor.test(study1_data$liwc_tone_mean_diff, study1_data$phq, method="spearman")

## Study 2
cor.test(study2_data$liwc_tone_mean_diff, study2_data$phq, method="spearman")
```

14-1. Robust regression testing prediction using LIWC sentiment score 
```{r ms 14-1, echo=FALSE}
## Study 1
ms14_study1_mod <- lmrob(phq_2   ~  phq + age + gender + edu + liwc_tone_mean_diff, data=study1_data,
                         control = lmrob.control(setting = "KS2014", k.max=2000))

tab_model(ms14_study1_mod,  terms = terms_use, 
          show.ci = FALSE, show.se = TRUE,
             pred.labels = pi, dv.labels = c(""), string.pred = "Coeffcient",
            show.stat = "TRUE", string.est = "Beta estimates", string.stat = "T-stat",
            string.se = "SE", string.p = "P")

# f^2 calculation
# model without sentiment score
ms14_study1_mod2<-lmrob(phq_2   ~  phq  + age + gender + edu, data=study1_data,  control = lmrob.control(setting = "KS2014", k.max=2000))
s1_mod_f <- (summary(ms14_study1_mod)$r.squared - summary(ms14_study1_mod2)$r.squared)/(1-summary(ms14_study1_mod)$r.squared)
sprintf('Study 1 regression model Cohen f^2 = %.3f', s1_mod_f)

## Study 2
ms14_study2_mod <- lmrob(phq_2   ~  phq + age + gender + edu + liwc_tone_mean_diff, data=study2_data, 
                         control = lmrob.control(setting = "KS2014", k.max=2000))

tab_model(ms14_study2_mod,  terms = terms_use, 
          show.ci = FALSE, show.se = TRUE,
             pred.labels = pi, dv.labels = c(""), string.pred = "Coeffcient",
            show.stat = "TRUE", string.est = "Beta estimates", string.stat = "T-stat",
            string.se = "SE", string.p = "P")

# f^2 calculation
# model without sentiment score
ms14_study2_mod2<-lmrob(phq_2   ~  phq  + age + gender + edu, data=study2_data,  control = lmrob.control(setting = "KS2014", k.max=2000))
s2_mod_f <- (summary(ms14_study2_mod)$r.squared - summary(ms14_study2_mod2)$r.squared)/(1-summary(ms14_study2_mod)$r.squared)
sprintf('Study 2 regression model Cohen f^2 = %.3f', s2_mod_f)
```

14-2. Robust regression LIWC sentiment score plot (Fig. 2B)
```{r ms 14-2}
liwc_reg_mod <- plot_summs(ms14_study1_mod, ms14_study2_mod, scale=FALSE, inner_ci_level = .95,  plot.distributions = FALSE,
                 rescale.distributions = TRUE,   
                 coefs = c(
                   "Initial \nPHQ-9 score" = 'phq',
                   "LIWC \nsentiment score" = "tone_mean_diff"),
                 model.names=c('Study 1', 'Study 2')) + scale_x_continuous(limits = c(-0.51, 1.01), 
                                                                           breaks=c(-0.50, 0.00, 0.50, 1.00))
fig_2b <- ggpar(liwc_reg_mod, xlab = 'Beta Coefficient',
            font.y = 0,
            ggtheme = theme_pubr()) + theme(legend.title = element_blank(), legend.position = c(0.3,0.95),
                                            legend.direction = "horizontal")
fig_2b

fig_2 <- ggarrange(fig_2a, fig_2b, ncol = 2, nrow = 1, labels = c("A", "B")) 
ggsave(filename = file.path(dir_save, "fig_2.pdf"), plot=fig_2, width=7, height=3.5, units="in", dpi=700)
```

15. Baseline mood ~ human sentiment score
```{r ms 15}
## Study 1
cor.test(study1_data$base_hap, study1_data$avg_human_tone_mean_diff, method="spearman")

## Study 2
cor.test(study2_data$base_hap, study2_data$avg_human_tone_mean_diff, method="spearman")
```


16. RPE ~ human sentiment score
```{r ms 16}
## Study 1
cor.test(study1_data$rpe, study1_data$avg_human_tone_mean_diff, method="spearman")

## Study 2
cor.test(study2_data$rpe, study2_data$avg_human_tone_mean_diff, method="spearman")
```

17. Fig. 3
```{r ms 17}
# Study 2 happiness data
# mat_file <- "real_v2_happydata.mat"
# 
# # Load the .mat file
# data <- readMat(file.path(dat_dir, mat_file))
# 
# # Access the structure of structures
# main_struct <- data$datatosave 
# nrow <- dim(data$datatosave)[2]
# df_list <- list()
# 
# # Iterate through the rows
# for (i in 1:nrow) {
#   # Access the 1x1 struct for each row
#   sub_struct <- main_struct[[i]]
#   
#   # Access and print the variables you need
#   variable1 <- sub_struct[[1]] # rawhappy
#   variable2 <- sub_struct[[12]] # Replace "variable2_name" with the actual variable name
#   
#   tmp_df <- data.frame(subjID = i, rawhappy = variable1, predhappy = variable2)
#   df_list[[i]] <- tmp_df
# }
# 
# final_df2 <- do.call(rbind, df_list)
# long_data2 <- final_df2 %>% 
#   gather(name, value, -subjID)
# long_data2 <- long_data2 %>% group_by(subjID, name) %>% mutate(data_point = row_number())
# 
# # subject ID = 7 r2
# subj_id = 220
# 
# data$datatosave[[subj_id]][[13]]
# 
# study2_r2 <- format(round(data$datatosave[[subj_id]][[13]], 2), nsmall = 2)
# 
# all2_r2 <- NULL
# 
# for (i in 1:length(data$datatosave)) {
#   #print(i)
#   all2_r2[i] <- data$datatosave[[i]][[13]]
# }
# 
# median(all2_r2)
# 
# # phq
# data_fin$phq[subj_id]
# data_fin$diag_dep[subj_id]
# 
# fig_3a <- ggplot(long_data2 %>% filter(subjID == subj_id), aes(x = data_point, y=value, group=name, linetype=name, shape=name, colour=name)) +
#   geom_line(size = 1) + ylim(c(0,100)) + 
#   geom_point(size = 3) + theme_pubr() + xlab('Rating Number') + ylab('Happiness Rating') + 
#   scale_linetype_manual(values = c("rawhappy" = "solid", "predhappy" = "solid"), labels = c("rawhappy" = "Raw Happiness", "predhappy" = "Predicted Happiness")) +
#   scale_shape_manual( values = c("rawhappy" = 16, "predhappy" = 17), labels = c("rawhappy" = "Raw Happiness", "predhappy" = "Predicted Happiness")) +
#   scale_color_manual(values = c("rawhappy" = "blue", "predhappy" = "red"), labels = c("rawhappy" = "Raw Happiness", "predhappy" = "Predicted Happiness")) + theme(legend.text=element_text(size=14), legend.position = c(0.375,0.85), legend.title = element_blank(),
#         text = element_text(size = 14), axis.title = element_text(size = 16))
# 
# fig_3a
# 
# # Fig 3b
# 
# # current mood (baseline happiness) by binned PHQ-9
# fig_3b <- study1_2_data %>%
#   group_by(Group = cut(phq, breaks = c(-Inf, 4, 9, 14, 19, +Inf), 
#                        labels = c("0-4", "5-9", "10-14","15-19", "20+"))) %>%
#   summarise(mean_basehap = mean(base_hap), sem_basehap = sd(base_hap) / sqrt(n())) %>%
#   
#   # Create the bar plot
#   ggplot() +
#   geom_point(aes(x = Group, y = mean_basehap, fill = Group), stat = "identity", size=1.5,
#              position = position_dodge(width = 0.4), width = 1) + geom_hline(yintercept=50, alpha=0.5) + 
#   geom_errorbar(aes(x = Group, ymin = mean_basehap - sem_basehap, ymax = mean_basehap + sem_basehap), size = 1, 
#                 position = position_dodge(width = 2), width = 0.2) +
#   # Customize plot aesthetics
#   labs(x = "Initial PHQ-9 Score", 
#        y = "Baseline Mood Parameter") +
#   theme_pubr() + ylim(c(0,100)) + theme(legend.position="none", text = element_text(size = 14), axis.title = element_text(size = 16))
# 
# fig_3b
# 
# fig_3 <- ggarrange(fig_3a, fig_3b, ncol=2, labels = c("A", "B"))
# ggsave(filename = file.path(dir_save, "fig_3.pdf"), plot=fig_3, width=9, height=4, units="in", dpi=600)

```

18. Robust regression testing current depression using LIWC sentiment score 
```{r ms 18, echo=TRUE}
## Study 1
ms18_study1_mod <- lmrob(phq   ~ age + gender + edu + avg_human_tone_mean_diff + base_hap, data=study1_data,
                         control = lmrob.control(setting = "KS2014", k.max=2000))

tab_model(ms18_study1_mod,  terms = terms_use, 
          show.ci = FALSE, show.se = TRUE,
             pred.labels = pi, dv.labels = c(""), string.pred = "Coeffcient",
            show.stat = "TRUE", string.est = "Beta estimates", string.stat = "T-stat",
            string.se = "SE", string.p = "P")

# f^2 calculation
# model without sentiment score
ms18_study1_mod2<-lmrob(phq   ~  age + gender + edu + avg_human_tone_mean_diff, 
                        data=study1_data,  control = lmrob.control(setting = "KS2014", k.max=2000))
s1_mod_f <- (summary(ms18_study1_mod)$r.squared - summary(ms18_study1_mod2)$r.squared)/(1-summary(ms18_study1_mod)$r.squared)
sprintf('Study 1 regression model Cohen f^2 = %.3f', s1_mod_f)

## Study 2
ms18_study2_mod <- lmrob(phq   ~ age + gender + edu + avg_human_tone_mean_diff + base_hap,
                         data=study2_data, 
                         control = lmrob.control(setting = "KS2014", k.max=2000))

tab_model(ms18_study2_mod,  terms = terms_use, 
          show.ci = FALSE, show.se = TRUE,
             pred.labels = pi, dv.labels = c(""), string.pred = "Coeffcient",
            show.stat = "TRUE", string.est = "Beta estimates", string.stat = "T-stat",
            string.se = "SE", string.p = "P")

# f^2 calculation
# model without sentiment score
ms18_study2_mod2<-lmrob(phq   ~  age + gender + edu + avg_human_tone_mean_diff, data=study2_data,  control = lmrob.control(setting = "KS2014", k.max=2000))
s2_mod_f <- (summary(ms18_study2_mod)$r.squared - summary(ms18_study2_mod2)$r.squared)/(1-summary(ms18_study2_mod)$r.squared)
sprintf('Study 2 regression model Cohen f^2 = %.3f', s2_mod_f)
```

19. Robust regression testing prediction using LIWC sentiment score 
```{r ms 19, echo=FALSE}
## Study 1
ms19_study1_mod <- lmrob(phq_2   ~ phq + age + gender + edu + base_hap, data=study1_data,
                         control = lmrob.control(setting = "KS2014", k.max=2000))

tab_model(ms19_study1_mod,  terms = terms_use, 
          show.ci = FALSE, show.se = TRUE,
             pred.labels = pi, dv.labels = c(""), string.pred = "Coeffcient",
            show.stat = "TRUE", string.est = "Beta estimates", string.stat = "T-stat",
            string.se = "SE", string.p = "P")

# f^2 calculation
# model without sentiment score
ms19_study1_mod2<-lmrob(phq_2  ~ phq + age + gender + edu, 
                        data=study1_data,  control = lmrob.control(setting = "KS2014", k.max=2000))
s1_mod_f <- (summary(ms19_study1_mod)$r.squared - summary(ms19_study1_mod2)$r.squared)/(1-summary(ms19_study1_mod)$r.squared)
sprintf('Study 1 regression model Cohen f^2 = %.3f', s1_mod_f)

## Study 2
ms19_study2_mod <- lmrob(phq_2   ~ phq + age + gender + edu + base_hap,
                         data=study2_data, 
                         control = lmrob.control(setting = "KS2014", k.max=2000))

tab_model(ms19_study2_mod,  terms = terms_use, 
          show.ci = FALSE, show.se = TRUE,
             pred.labels = pi, dv.labels = c(""), string.pred = "Coeffcient",
            show.stat = "TRUE", string.est = "Beta estimates", string.stat = "T-stat",
            string.se = "SE", string.p = "P")

# f^2 calculation
# model without sentiment score
ms19_study2_mod2<-lmrob(phq_2   ~phq + age + gender + edu, data=study2_data,  control = lmrob.control(setting = "KS2014", k.max=2000))
s2_mod_f <- (summary(ms19_study2_mod)$r.squared - summary(ms19_study2_mod2)$r.squared)/(1-summary(ms19_study2_mod)$r.squared)
sprintf('Study 2 regression model Cohen f^2 = %.5f', s2_mod_f)
```

20. Robust regression testing Human sentiment score beyond baseline mood
```{r ms 20, echo=TRUE}
## Study 1
ms20_study1_mod <- lmrob(phq_2   ~ phq + age + gender + edu + base_hap + avg_human_tone_mean_diff, data=study1_data,
                         control = lmrob.control(setting = "KS2014", k.max=2000))

tab_model(ms20_study1_mod,  terms = terms_use, 
          show.ci = FALSE, show.se = TRUE,
             pred.labels = pi, dv.labels = c(""), string.pred = "Coeffcient",
            show.stat = "TRUE", string.est = "Beta estimates", string.stat = "T-stat",
            string.se = "SE", string.p = "P")

# f^2 calculation
# model without sentiment score
ms20_study1_mod2<-lmrob(phq_2  ~ phq + age + gender + edu + base_hap, 
                        data=study1_data,  control = lmrob.control(setting = "KS2014", k.max=2000))
s1_mod_f <- (summary(ms20_study1_mod)$r.squared - summary(ms20_study1_mod2)$r.squared)/(1-summary(ms20_study1_mod)$r.squared)
sprintf('Study 1 regression model Cohen f^2 = %.3f', s1_mod_f)

## Study 2
ms20_study2_mod <- lmrob(phq_2   ~ phq + age + gender + edu + base_hap + avg_human_tone_mean_diff,
                         data=study2_data, 
                         control = lmrob.control(setting = "KS2014", k.max=2000))

tab_model(ms20_study2_mod,  terms = terms_use, 
          show.ci = FALSE, show.se = TRUE,
             pred.labels = pi, dv.labels = c(""), string.pred = "Coeffcient",
            show.stat = "TRUE", string.est = "Beta estimates", string.stat = "T-stat",
            string.se = "SE", string.p = "P")

# f^2 calculation
# model without sentiment score
ms20_study2_mod2<-lmrob(phq_2   ~ phq + age + gender + edu + base_hap, data=study2_data,  control = lmrob.control(setting = "KS2014", k.max=2000))
s2_mod_f <- (summary(ms20_study2_mod)$r.squared - summary(ms20_study2_mod2)$r.squared)/(1-summary(ms20_study2_mod)$r.squared)
sprintf('Study 2 regression model Cohen f^2 = %.3f', s2_mod_f)
```

21. Robust regression testing GPT sentiment score beyond baseline mood
```{r ms 21, echo=FALSE}
## Study 1
ms21_study1_mod <- lmrob(phq_2   ~ phq + age + gender + edu + base_hap + gpt_tone_mean_diff, data=study1_data,
                         control = lmrob.control(setting = "KS2014", k.max=2000))

tab_model(ms21_study1_mod,  terms = terms_use, 
          show.ci = FALSE, show.se = TRUE,
             pred.labels = pi, dv.labels = c(""), string.pred = "Coeffcient",
            show.stat = "TRUE", string.est = "Beta estimates", string.stat = "T-stat",
            string.se = "SE", string.p = "P")

# f^2 calculation
# model without sentiment score
ms21_study1_mod2<-lmrob(phq_2  ~ phq + age + gender + edu + base_hap, 
                        data=study1_data,  control = lmrob.control(setting = "KS2014", k.max=2000))
s1_mod_f <- (summary(ms21_study1_mod)$r.squared - summary(ms21_study1_mod2)$r.squared)/(1-summary(ms21_study1_mod)$r.squared)
sprintf('Study 1 regression model Cohen f^2 = %.3f', s1_mod_f)

## Study 2
ms21_study2_mod <- lmrob(phq_2   ~ phq + age + gender + edu + base_hap + gpt_tone_mean_diff,
                         data=study2_data, 
                         control = lmrob.control(setting = "KS2014", k.max=2000))

tab_model(ms21_study2_mod,  terms = terms_use, 
          show.ci = FALSE, show.se = TRUE,
             pred.labels = pi, dv.labels = c(""), string.pred = "Coeffcient",
            show.stat = "TRUE", string.est = "Beta estimates", string.stat = "T-stat",
            string.se = "SE", string.p = "P")

# f^2 calculation
# model without sentiment score
ms21_study2_mod2<-lmrob(phq_2   ~ phq + age + gender + edu + base_hap, data=study2_data,  control = lmrob.control(setting = "KS2014", k.max=2000))
s2_mod_f <- (summary(ms21_study2_mod)$r.squared - summary(ms21_study2_mod2)$r.squared)/(1-summary(ms21_study2_mod)$r.squared)
sprintf('Study 2 regression model Cohen f^2 = %.3f', s2_mod_f)
```

22. Robust regression testing LIWC sentiment score beyond baseline mood
```{r ms 22, echo=FALSE}

## Study 1
ms22_study1_mod <- lmrob(phq_2   ~ phq + age + gender + edu + base_hap + liwc_tone_mean_diff, data=study1_data,
                         control = lmrob.control(setting = "KS2014", k.max=2000))

tab_model(ms22_study1_mod,  terms = terms_use, 
          show.ci = FALSE, show.se = TRUE,
             pred.labels = pi, dv.labels = c(""), string.pred = "Coeffcient",
            show.stat = "TRUE", string.est = "Beta estimates", string.stat = "T-stat",
            string.se = "SE", string.p = "P")

# f^2 calculation
# model without sentiment score
ms22_study1_mod2<-lmrob(phq_2  ~ phq + age + gender + edu + base_hap, 
                        data=study1_data,  control = lmrob.control(setting = "KS2014", k.max=2000))
s1_mod_f <- (summary(ms22_study1_mod)$r.squared - summary(ms22_study1_mod2)$r.squared)/(1-summary(ms22_study1_mod)$r.squared)
sprintf('Study 1 regression model Cohen f^2 = %.3f', s1_mod_f)

## Study 2
ms22_study2_mod <- lmrob(phq_2   ~ phq + age + gender + edu + base_hap + liwc_tone_mean_diff,
                         data=study2_data, 
                         control = lmrob.control(setting = "KS2014", k.max=2000))

tab_model(ms22_study2_mod,  terms = terms_use, 
          show.ci = FALSE, show.se = TRUE,
             pred.labels = pi, dv.labels = c(""), string.pred = "Coeffcient",
            show.stat = "TRUE", string.est = "Beta estimates", string.stat = "T-stat",
            string.se = "SE", string.p = "P")

# f^2 calculation
# model without sentiment score
ms22_study2_mod2<-lmrob(phq_2   ~ phq + age + gender + edu + base_hap, data=study2_data,  control = lmrob.control(setting = "KS2014", k.max=2000))
s2_mod_f <- (summary(ms22_study2_mod)$r.squared - summary(ms22_study2_mod2)$r.squared)/(1-summary(ms22_study2_mod)$r.squared)
sprintf('Study 2 regression model Cohen f^2 = %.3f', s2_mod_f)
```

